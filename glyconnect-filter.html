<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../sortable-list/sortable-list.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-styles/element-styles/paper-material-styles.html">
<!--
`glyconnect-filter`
This element provides filter box in glyconnect

@demo demo/index.html
-->

<dom-module id="glyconnect-filter">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment paper-material-styles"></style>
        <style>
            :host {
                display: block;
            }
            iron-icon[disabled]{
                display: none;
            }
            .enzymeList{
                padding: 5px;
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
                min-width: 200px;
                align-content: center;
            }
            .enzymeSelected{
                padding: 5px;
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
                min-height: 300px;
                align-items: right;
            }
            paper-button.indigo {
                background-color: var(--paper-indigo-500);
                color: white;
                --paper-button-raised-keyboard-focus: {
                    color: white !important;
                };
            }
            paper-button#filterToggleButton {
                width: 100%;
            }
            paper-button#updateButton {
                height: 50%;
                margin: 15px 30px;
            }
            #glycanFilterHeader {
                font-size: 16px;
                font-weight: 500;
                line-height: 25px;
            }
            .card {
                /*background-color: #cc3300;*/
                font-size: 16px;
                padding: 15px 15px 15px 15px;
                /*box-sizing: border-box;*/
                margin: 10px;
                flex: 0 0 auto;
                color: white;
            }
            paper-tab:not(:last-child) {
                border-right: solid;
                border-color: #757575 ;
                border-width: 1px;
            }
            paper-tab.iron-selected {
                background-color: var(--paper-indigo-500);
                color: white;
            }
            paper-tabs{
              --paper-tabs-selection-bar-color: #eee;
              background-color: #eeeeee;
              color: black;
              font-size: 20px;
              font-weight: 600;
              border-radius: 5px;
              margin: 20px;
              box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            }
            .materialCard {
                margin: 20px;
                background: #eeeeee;
                @apply --paper-material-elevation-2;

      }
      paper-tabs{
        --paper-tabs-selection-bar-color: #eee;
        background-color: #eeeeee;
        color: black;
        font-size: 20px;
        font-weight: 600;
        border-radius: 5px;
        margin: 20px;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }
      .title {
        padding-top: 11px;
        color : white;
        font-size: 20px;
      }
      paper-icon-button.huge {
        width: 50px;
        height: 50px;
      }
    </style>
    <iron-ajax
            id="ajaxDictionary"
            handle-as="json"
            method="GET"
            last-response="{{jsonGlobalProperties}}"
            on-response="handleResponse"
    ></iron-ajax>
      <paper-header-panel id="glycanTypeFilter" class="blue" mode="seamed">
         <div id="glycanFilterHeader" class="paper-header">
             <paper-button id="filterToggleButton" class="indigo" on-click="_toggleNGlycan" toggles raised>
                 <iron-icon id="expandIconn" icon="icons:chevron-right" alt="unfold" ></iron-icon>
                 <iron-icon id="foldIconn" icon="icons:expand-more" alt="fold" disabled></iron-icon>
                 N-linked glycans
             </paper-button>
         </div>
      </paper-header-panel>
      <iron-collapse id="glycanFilterN" class="horizontal center-justified">
         <div class="layout horizontal flex" >
          <paper-material elevation="2" class="flex">
               <app-layout class="layout horizontal flex">
                   <paper-icon-button class="huge" disabled style="color: white" icon="icons:view-list"></paper-icon-button>
                   <span class="title">N-Glycan</span>
               </app-layout>
               <sortable-list id="selectedN" group="test"  animation="150" class="enzymeSelected"></sortable-list>
               <div class="horizontal end-justified layout">
                   <paper-button id="updateButton" class="indigo" on-tap="selectedPropN">Search</paper-button>
                   <paper-button id="updateButton" class="indigo" on-tap="clearFunction">Clear</paper-button>
                   <iron-ajax
                     id="requestStruct"
                     url="http://mendel.isb-sib.ch:8083/api/glycosylations?glycanType=n-linked"
                     params=''
                     handle-as="json"
                     last-response="{{octData}}"
                     ></iron-ajax>
               </div>
           </paper-material>
         </div>
         <div class="layout vertical flex">
             <paper-tabs selected="{{selected}}"  no-bar>
                 <paper-tab>Cores</paper-tab>
                 <paper-tab>Structural properties</paper-tab>
                 <paper-tab>Determinants</paper-tab>
             </paper-tabs>
             <iron-pages selected="{{selected}}">
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{coreTypeO}}">
                        <paper-button typeLink="O" raised id={{idCreator(item.name)}}O data-id$="{{item.class}}={{item.name}}" coreTypeO="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}} </paper-button>
                    </template>
                </div>
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{propO}}">
                        <paper-button typeLink="O" raised id={{item.name}}O data-id$="{{item.class}}={{item.name}}" propO="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                    </template>
                </div>
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{detO}}">
                        <paper-button typeLink="O" raised id={{idCreator(item.name)}}O data-id$="{{item.class}}={{item.name}}" detO="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                    </template>
                </div>
              </iron-pages>
            </div>
        </iron-collapse>
        <br><br>
        <app-header-layout id="glycanTypeFilter" class="blue" mode="seamed">
            <div id="glycanFilterHeader" class="paper-header">
                <paper-button id="filterToggleButton" class="indigo" on-click="_toggleNOGlycan" toggles raised>
                    <iron-icon id="expandIcon" icon="icons:chevron-right" alt="unfold" ></iron-icon>
                    <iron-icon id="foldIcon" icon="icons:expand-more" alt="fold" disabled></iron-icon>
                    Non-attached to proteins
                </paper-button>
            </div>
        </app-header-layout>
        <iron-collapse id="glycanFilterNO" class="horizontal center-justified">
            <div class="layout horizontal flex" >
                <div class="layout materialCard flex">
                    <app-toolbar>
                        <paper-icon-button disabled style="color: white" icon="icons:view-list"></paper-icon-button>
                        <span class="title"> Non-attached to proteins</span>
                    </app-toolbar>
                    <div id="selectedNP" class="enzymeSelected">
                     </div>
                    <div class="horizontal end-justified layout">
                      <paper-button id="updateButton" class="indigo" on-tap="selectedPropNP">Search</paper-button>
                      <paper-button id="updateButton" typeLink="NP" class="indigo" on-tap="clearFilter">Clear</paper-button>
                    </div>
                </div>
            </div>
            <div id="" class="layout vertical flex">
             <paper-tabs selected="{{selected}}"  no-bar>
                 <paper-tab>Cores</paper-tab>
                 <paper-tab>Structural properties</paper-tab>
                 <paper-tab>Determinants</paper-tab>
             </paper-tabs>
             <iron-pages selected="{{selected}}">
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{coreTypeNP}}">
                        <paper-button typeLink="NP" raised id={{item.name}}NP data-id$="{{item.class}}={{item.name}}" coreTypeNP="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}} </paper-button>
                    </template>
                </div>
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{propNP}}">
                        <paper-button typeLink="NP" raised id={{item.name}}NP data-id$="{{item.class}}={{item.name}}" propNP="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                    </template>
                </div>
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{detNP}}">
                        <paper-button typeLink="NP" raised id={{idCreator(item.name)}}NP data-id$="{{item.class}}={{item.name}}" detO="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                    </template>
                </div>
              </iron-pages>
            </div>
        </iron-collapse>
    </template>

    <script>
      /** @polymerElement */
      class GlyconnectFilter extends Polymer.Element {
        static get is() { return 'glyconnect-filter'; }
        static get properties() {
          return {
            repos: {
              type: Array
            },
            selected: {
              type: String,
              value: 0
            },
            filterOutput: {
              type: Array,
              reflectToAttribute: true,
              notify: true
            }
          };
        }

        constructor() {
          super();
        }

        selectedPropN (){
          var selN =  Polymer.dom(this.$.selectedN).querySelectorAll("paper-button");
          var jsonParam = this.param(selN);
          jsonParam.glycanType = 'n-linked';
          this.filterOutput = jsonParam;
        }
        selectedPropO(){
          var selO = Polymer.dom(this.$.selectedO).querySelectorAll("paper-button");
          var jsonParam = this.param(selO);
          jsonParam.glycanType = 'o-linked';
          this.filterOutput = jsonParam;
        }
        selectedPropNP(){
          var selNP = Polymer.dom(this.$.selectedNP).querySelectorAll("paper-button");
          var jsonParam = this.param(selNP);
          jsonParam.glycanType = 'free';
          this.filterOutput = jsonParam;
        }
        param(propArray){
          var myJson = {};
          for (var i = 0; i < propArray.length; i++) {
            var x = propArray[i].getAttribute("data-id");
            var s = x.split("=");
            if (s[0] in myJson) {
              myJson[s[0]].push(s[1])
            } else {
              myJson[s[0]]=[s[1]];
            }
          }
          return myJson;
        }
        connectedCallback (){
          super.connectedCallback();
          this.$.ajaxDictionary.url = this.resolveUrl('dictionary/jsonGlobalProperties.json');
          this.$.ajaxDictionary.generateRequest();
        }
        handleResponse(data){
          var jsonGlobalProperties = data.detail.response;
          this.coreTypeO = jsonGlobalProperties['O-linked']['core'];
          this.coreTypeN = jsonGlobalProperties['N-linked']['core'];
          this.propO = jsonGlobalProperties['O-linked']['prop'];
          this.propN = jsonGlobalProperties['N-linked']['prop'];
          this.detO = jsonGlobalProperties['O-linked']['det'];
          this.detN = jsonGlobalProperties['N-linked']['det'];
          this.propNP = jsonGlobalProperties['Non attached to proteins']['prop'];
          this.detNP = jsonGlobalProperties['Non attached to proteins']['det'];
          this.coreTypeNP = jsonGlobalProperties['Non attached to proteins']['core'];
        }
        _toggleNGlycan () {
          this.$.glycanFilterN.toggle();
          if(this.$.foldIcon.hasAttribute('disabled')){
            this.$.expandIcon.setAttribute('disabled', 'true');
            this.$.foldIcon.removeAttribute('disabled');
          }else{
            this.$.foldIcon.setAttribute('disabled', 'true');
            this.$.expandIcon.removeAttribute('disabled');
          }
        }
        _toggleOGlycan () {
          this.$.glycanFilterO.toggle();
          if(this.$.foldIcon.hasAttribute('disabled')){
            this.$.expandIcon.setAttribute('disabled', 'true');
            this.$.foldIcon.removeAttribute('disabled');
          }else{
            this.$.foldIcon.setAttribute('disabled', 'true');
            this.$.expandIcon.removeAttribute('disabled');
          }
        }
        _toggleNOGlycan () {
          this.$.glycanFilterNO.toggle();
          if(this.$.foldIcon.hasAttribute('disabled')){
            this.$.expandIcon.setAttribute('disabled', 'true');
            this.$.foldIcon.removeAttribute('disabled');
          }else{
            this.$.foldIcon.setAttribute('disabled', 'true');
            this.$.expandIcon.removeAttribute('disabled');
          }
        }
        clearFilter(event) {
          var typeGlyco = event.target.getAttribute("typeLink");
          var vr = this.shadowRoot.querySelector("#selected"+typeGlyco);
          var toClear =  Polymer.dom(vr).querySelectorAll("paper-button");
          for (var i = 0; i < toClear.length; i++) {
            Polymer.dom(this.root).querySelector('paper-button[id='+toClear[i].id.replace("-clone",'')+']').hidden=false;
            toClear[i].remove();
          }
        }
        createTag(event) {
         var typeTag = event.target.getAttribute("typeLink");
         var list = Polymer.dom(this.root).querySelector("#selected"+typeTag);
         var sourceEl = event.target;
         var cloneEl = sourceEl.cloneNode(true);
         event.target.hidden=true;
         cloneEl.id=cloneEl.id+"-clone";
         list.insertBefore(cloneEl, null);
         cloneEl.addEventListener('tap', e => {this.destroyTag(e)});
       }
       destroyTag(pr) {
         Polymer.dom(this.root).querySelector('paper-button[id='+pr.target.id.replace("-clone",'')+']').hidden=false;
        pr.target.remove();
       }
       idCreator(id) {
         return "d_"+id.replace(/ /g,'').replace(/\(/g, '').replace(/\)/g, '').replace(/\,/g, "").replace("/","").replace(/\'/g,"");
       }
      }

      window.customElements.define(GlyconnectFilter.is, GlyconnectFilter);

    </script>
</dom-module>
