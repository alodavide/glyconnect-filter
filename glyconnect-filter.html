<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../vaadin-upload/vaadin-upload.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../glycosetta-stone/glycosetta-stone.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<!--
`glyconnect-filter`
This element provides filter box in glyconnect
@demo demo/index.html
-->
<!-- file_format_morten=[Hex]5 [HexNAc]5 [dHex]2 [NeuAc]3 -->
<dom-module id="glyconnect-filter">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment paper-material-styles"></style>
        <style>
            :host {
                display: block;
            }
            iron-icon[disabled]{
                display: none;
            }
            .enzymeList{
                padding: 5px;
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
                min-width: 200px;
                align-content: center;
            }
            .enzymeSelected{
                padding: 5px;
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
                min-height: 100px;
                align-items: right;
            }
            paper-button.indigo {
                background-color: var(--paper-indigo-500);
                color: white;
                --paper-button-raised-keyboard-focus: {
                    color: white !important;
                };
            }
            paper-button.filterToggleButton {
                width: 100%;
            }
            paper-button.updateButton {
                margin: 13px;
                font-size: 16px;
            }
            .glycanFilterHeader {
                font-size: 16px;
                font-weight: 500;
                line-height: 25px;
            }
            .card {
                background-color: #cc3300;
                font-size: 16px;
                padding: 15px 15px 15px 15px;
                /*box-sizing: border-box;*/
                margin: 10px;
                flex: 0 0 auto;
                color: white;
            }
            paper-tab:not(:last-child) {
                border-right: solid;
                border-color: #757575 ;
                border-width: 1px;
            }
            paper-tab.iron-selected {
                background-color: var(--paper-indigo-500);
                color: white;
            }
            paper-tabs{
              --paper-tabs-selection-bar-color: #eee;
              background-color: #eeeeee;
              color: black;
              font-size: 20px;
              font-weight: 600;
              border-radius: 5px;
              margin: 20px;
              box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            }
            .materialCard {
                margin: 20px;
                background: #eeeeee;
                @apply --paper-material-elevation-2;
            }
            paper-item.fancy {
              --paper-item-focused: {
                background: var(--paper-amber-500);
              };
              --paper-item-focused-before: {
                opacity: 0;
              };
            }
            .doubleRangeBox{
                width: 300px;
                margin: 10px 20px 10px 20px;
            }
            #rangeBox {
                padding: 30px 20px 20px 20px;
            }
            #clearIcon {
              margin: 40px 20px 20px 20px;
              float: right;
            }
            vaadin-upload.thick-border {
                padding: 14px;
                /*background: #eee;*/
                /*border-radius: 0;*/
            }
            .textarea{
              /*background-color: #E6E6E6;*/
              width: 520px;
              font-size: 14px;
              border-color: var(--paper-indigo-500);
              padding: 30px 20px 20px 20px;
              margin: 40px 20px 20px 20px;
              border-radius: 5px;
            }
        </style>
        <iron-ajax
                id="ajaxDictionary"
                handle-as="json"
                method="GET"
                on-response="handleResponse"
        ></iron-ajax>
        <iron-ajax
                id="proteinDictionary"
                handle-as="json"
                method="GET"
                on-response="handleProtein"
        ></iron-ajax>
        <app-header-layout mode="seamed">
            <div class ="glycanFilterHeader">
                <paper-button class="indigo filterToggleButton" on-click="_toggleProtein" toggles raised>
                    <iron-icon id="expandIcon" icon="icons:chevron-right" alt="unfold" ></iron-icon>
                    <iron-icon id="foldIcon" icon="icons:expand-more" alt="fold" disabled></iron-icon>
                    Protein
                </paper-button>
            </div>
        </app-header-layout>
        <iron-collapse id="glycanFilterProt" class="horizontal center-justified">
              <vaadin-combo-box typeLink="Protein" id="protDropDown" required label="Protein"></vaadin-combo-box>
              <div>
                <div class="layout materialCard flex">
                  <app-toolbar>
                      <paper-icon-button disabled style="color: white" icon="icons:view-list"></paper-icon-button>
                      <span class="title">Species</span>
                  </app-toolbar>
                  <div id="availableSpecies" class="enzymeSelected">
                    <template is="dom-repeat" items="{{species}}">
                         <paper-button typeLink="Protein" id="{{_getLabelSpecies(item)}}Prot" speciesButton="{{item}}" class="card" on-tap="checkHowmany">{{item}}</paper-button>
                    </template>
                  </div>
                </div>
                <div id= "selectedSpecies" class="layout materialCard flex">
                      <app-toolbar>
                          <paper-icon-button disabled style="color: white" icon="icons:view-list"></paper-icon-button>
                          <span class="title">Selected species</span>
                      </app-toolbar>
                      <div id="selectedProtein" class="enzymeSelected">
                       </div>
                       <div class="horizontal end-justified layout">
                           <paper-button typeLink="Protein" class="indigo updateButton" on-tap="clearFilter">Clear</paper-button>
                       </div>
                </div>
              </div>
              <paper-button class="indigo updateButton" taxo="{{item}}" id="sendDataProt" raised on-tap="_searchProtein">Search</paper-button>
        </iron-collapse>
        <br><br>
        <app-header-layout mode="seamed">
            <div class="glycanFilterHeader">
                <paper-button class="filterToggleButton indigo" on-click="_toggleGlycanFilter" toggles raised>
                    <iron-icon id="expandIcon" icon="icons:chevron-right" alt="unfold" ></iron-icon>
                    <iron-icon id="foldIcon" icon="icons:expand-more" alt="fold" disabled></iron-icon>
                    Composition
                </paper-button>
            </div>
        </app-header-layout>
        <iron-collapse id="glycanFilterBox" class="horizontal center-justified">
          <div class="layout vertical flex">
           <paper-tabs selected="{{selected}}" no-bar>
               <paper-tab>File upload</paper-tab>
               <paper-tab>List of composition</paper-tab>
               <paper-tab on-click = '_resetAll'>Monosaccharide selectors</paper-tab>
           </paper-tabs>
           <iron-pages selected="{{selected}}">
              <div class="layout materialCard flex">
                   <vaadin-upload id="bUpload" nodrop class="thick-border" on-upload-before="uploadExperiment">
                       <div class="drop-label" style= "padding: 20px">
                           <iron-icon icon="description"></iron-icon>
                           Drop your files here (only text files).<br>
                            <p>Write comma-separated compositions as Oxford nomenclature or using the following monosaccharide abbreviations: </p>
                            <p>Hex, HexNAc, dHex (e.g. fucose), NeuAc, NeuGc, Pen (e.g. xylose), S (sulphate), P (phosphate), KDN, KDO, HexA (e.g. GlcA), Met (methyl), Ac (acetyl), Other</p>
                            <p>e.g. Hex HexNAc3 dHex4 (for more than 1 monosaccharide specify the corresponding number).</p>
                            <p></p>
                       </div>
                       <div class="layout wrap">
                         <glycosetta-stone id="oxfordFile" input-value=""></glycosetta-stone>
                       </div>
                       <div class="horizontal end-justified layout">
                         <paper-button class="indigo updateButton" on-tap="sendData">Submit</paper-button>
                       </div>
                   </vaadin-upload>
               </div>
               <div class="layout materialCard flex">
                 <div style="padding:10px">
                  <p>Write compositions as Oxford nomenclature (CAPITAL letters) or using the following monosaccharide abbreviations: </p>
                  <p>Hex, HexNAc, dHex (e.g. fucose), NeuAc, NeuGc, Pen (e.g. xylose), S (sulphate), P (phosphate), KDN, KDO, HexA (e.g. GlcA), Met (methyl), Ac (acetyl), Other</p>
                  <p>e.g. Hex HexNAc3 dHex4 (for more than 1 monosaccharide specify the corresponding number)</p>
                 </div>
                 <paper-button class="indigo updateButton" raised on-tap="openDialog">Input example</paper-button>
                 <paper-dialog id="dialog" modal>
                    <p>Oxford: M3, Fa2, A2, A2[3]G1, A2G2, A2G2S1, FA2, FA2[6]G1, FA2G2S2, A4G4, A4, Hy, C</p><br>
                    <p>Hex3 HexNAc5 dHex2, Hex HexNAc dHex2, Hex HexNAc dHex NeuAc, Hex4 HexNAc3 Pen, Hex5 HexNAc4 P</p>
                    <div class="buttons">
                      <paper-button dialog-confirm autofocus>Close</paper-button>
                    </div>
                 </paper-dialog>
                 <paper-input style ="padding: 10px" label="input comma-separated compositions" id="compoCommaList" value="{{compositions}}"></paper-input>
                 <div class="layout wrap">
                   <glycosetta-stone id="oxfordInput" input-value=""></glycosetta-stone>
                 </div>
                 <div class="horizontal end-justified layout">
                   <paper-button class="indigo updateButton" on-tap='_getCompoList'>Search</paper-button>
                 </div>
               </div>
               <div>
                 <div class="layout materialCard flex"><link rel="import" href="../iron-list/iron-list.html">
                   <iron-icon id="clearIcon" icon="icons:autorenew" alt="reset" on-click="resetSelector"></iron-icon>
                     <div id="rangeBox" class="layout horizontal wrap">
                         <template is="dom-repeat" items="{{monosaccharides}}">
                             <div id="{{item}}toHide" class="doubleRangeBox">
                                 <span>{{_getLabel(item)}}</span>
                                 <div class="layout horizontal">
                                   <paper-slider id="{{item}}RangeMin" snaps max="12" max-markers="12" step="1" value = '0' editable></paper-slider>
                                   <span>Value</span>
                                 </div>
                             </div>
                         </template>

                     </div>
                        <iron-autogrow-textarea label="" class = 'textarea' id="compoFromSelectors" value="{{compoCopied}}"></iron-autogrow-textarea>
                     <div>
                       <paper-button class="indigo updateButton" on-tap='_addCompo'>Add composition</paper-button>
                     </div>
                     <div class="horizontal end-justified layout">
                       <paper-button class="indigo updateButton" on-tap='_getCompo'>Search</paper-button>
                     </div>
                 </div>

                 <div class="layout materialCard flex">
                   <template is="dom-repeat" items="{{spareMonosac}}">
                        <paper-button id={{item}} class="card" on-tap="createSelector">{{_getLabel(item)}}</paper-button>
                   </template>
                 </div>
               </div>
             </iron-pages>
           </div>
        </iron-collapse>
        <br><br>
        <app-header-layout mode="seamed">
            <div class="glycanFilterHeader">
                <paper-button class="indigo filterToggleButton" on-click="_toggleNGlycan" toggles raised>
                    <iron-icon id="expandIcon" icon="icons:chevron-right" alt="unfold" ></iron-icon>
                    <iron-icon id="foldIcon" icon="icons:expand-more" alt="fold" disabled></iron-icon>
                    N-linked glycans
                </paper-button>
            </div>
        </app-header-layout>
        <iron-collapse id="glycanFilterN" class="horizontal center-justified">
            <div class="layout horizontal flex" >
              <div class="layout materialCard flex">
                    <app-toolbar>
                        <paper-icon-button disabled style="color: white" icon="icons:view-list"></paper-icon-button>
                        <span class="title">N-Glycan</span>
                    </app-toolbar>
                    <div id="selectedN" class="enzymeSelected">
                     </div>
                    <div class="horizontal end-justified layout">
                        <paper-button class="indigo updateButton" on-tap="selectedPropN">Search</paper-button>
                        <paper-button typeLink="N" class="indigo updateButton" on-tap="clearFilter">Clear</paper-button>
                    </div>
              </div>
            </div>
              <div class="layout vertical flex">
               <paper-tabs selected="{{selected}}" no-bar>
                   <paper-tab>Cores</paper-tab>
                   <paper-tab>Structural properties</paper-tab>
                   <paper-tab>Determinants</paper-tab>
               </paper-tabs>
               <iron-pages selected="{{selected}}">
                  <div class="layout materialCard flex">
                       <template is="dom-repeat" items="{{coreTypeN}}">
                            <paper-button typeLink="N" id={{item.name}}N raised data-id$="{{item.class}}={{item.name}}" coreTypeN="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                       </template>
                   </div>
                   <div class="layout materialCard flex">
                       <template is="dom-repeat" items="{{propN}}">
                           <paper-button typeLink="N" id="{{item.name}}N" raised data-id$="{{item.class}}={{item.name}}" propN="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                       </template>
                   </div>
                   <div class="layout materialCard flex"><link rel="import" href="../iron-list/iron-list.html">
                       <template is="dom-repeat" items="{{detN}}">
                           <paper-button typeLink="N" id="{{idCreator(item.name)}}N" raised data-id$="{{item.class}}={{item.name}}" detN="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                       </template>
                   </div>
               </iron-pages>
             </div>
        </iron-collapse>
        <br><br>
        <app-header-layout mode="seamed">
            <div class="glycanFilterHeader">
                <paper-button class="indigo filterToggleButton" on-click="_toggleOGlycan" toggles raised>
                    <iron-icon id="expandIcon" icon="icons:chevron-right" alt="unfold" ></iron-icon>
                    <iron-icon id="foldIcon" icon="icons:expand-more" alt="fold" disabled></iron-icon>
                    O-linked glycans
                </paper-button>
            </div>
        </app-header-layout>
        <iron-collapse id="glycanFilterO" class="horizontal center-justified">
            <div class="layout horizontal flex" >
                <div class="layout materialCard flex">
                    <app-toolbar>
                        <paper-icon-button disabled style="color: white" icon="icons:view-list"></paper-icon-button>
                        <span class="title">O-Glycan</span>
                    </app-toolbar>
                    <div id="selectedO" class="enzymeSelected">
                     </div>
                    <div class="horizontal end-justified layout">
                      <paper-button class="indigo updateButton" on-tap="selectedPropO">Search</paper-button>
                      <paper-button typeLink="O" class="indigo updateButton" on-tap="clearFilter">Clear</paper-button>
                    </div>
                </div>
            </div>
            <div class="layout vertical flex">
             <paper-tabs selected="{{selected}}"  no-bar>
                 <paper-tab>Cores</paper-tab>
                 <paper-tab>Structural properties</paper-tab>
                 <paper-tab>Determinants</paper-tab>
             </paper-tabs>
             <iron-pages selected="{{selected}}">
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{coreTypeO}}">
                        <paper-button typeLink="O" raised id={{idCreator(item.name)}}O data-id$="{{item.class}}={{item.name}}" coreTypeO="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}} </paper-button>
                    </template>
                </div>
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{propO}}">
                        <paper-button typeLink="O" raised id={{item.name}}O data-id$="{{item.class}}={{item.name}}" propO="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                    </template>
                </div>
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{detO}}">
                        <paper-button typeLink="O" raised id={{idCreator(item.name)}}O data-id$="{{item.class}}={{item.name}}" detO="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                    </template>
                </div>
              </iron-pages>
            </div>
        </iron-collapse>
        <br><br>
        <app-header-layout mode="seamed">
            <div class="glycanFilterHeader">
                <paper-button class="indigo filterToggleButton" on-click="_toggleNOGlycan" toggles raised>
                    <iron-icon id="expandIcon" icon="icons:chevron-right" alt="unfold" ></iron-icon>
                    <iron-icon id="foldIcon" icon="icons:expand-more" alt="fold" disabled></iron-icon>
                    Non-attached to proteins
                </paper-button>
            </div>
        </app-header-layout>
        <iron-collapse id="glycanFilterNO" class="horizontal center-justified">
            <div class="layout horizontal flex" >
                <div class="layout materialCard flex">
                    <app-toolbar>
                        <paper-icon-button disabled style="color: white" icon="icons:view-list"></paper-icon-button>
                        <span class="title"> Non-attached to proteins</span>
                    </app-toolbar>
                    <div id="selectedNP" class="enzymeSelected">
                     </div>
                    <div class="horizontal end-justified layout">
                      <paper-button class="indigo updateButton" on-tap="selectedPropNP">Search</paper-button>
                      <paper-button typeLink="NP" class="indigo updateButton" on-tap="clearFilter">Clear</paper-button>
                    </div>
                </div>
            </div>
            <div class="layout vertical flex">
             <paper-tabs selected="{{selected}}"  no-bar>
                 <paper-tab>Cores</paper-tab>
                 <paper-tab>Structural properties</paper-tab>
                 <paper-tab>Determinants</paper-tab>
             </paper-tabs>
             <iron-pages selected="{{selected}}">
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{coreTypeNP}}">
                        <paper-button typeLink="NP" raised id={{item.name}}NP data-id$="{{item.class}}={{item.name}}" coreTypeNP="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}} </paper-button>
                    </template>
                </div>
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{propNP}}">
                        <paper-button typeLink="NP" raised id={{item.name}}NP data-id$="{{item.class}}={{item.name}}" propNP="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                    </template>
                </div>
                <div class="layout materialCard flex">
                    <template is="dom-repeat" items="{{detNP}}">
                        <paper-button typeLink="NP" raised id={{idCreator(item.name)}}NP data-id$="{{item.class}}={{item.name}}" detO="{{item}}" class="card" style$="background-color:{{item.color}}" on-tap="createTag">{{item.name}}</paper-button>
                    </template>
                </div>
              </iron-pages>
            </div>
        </iron-collapse>
    </template>

    <script>
    /** @polymerElement */
    class GlyconnectFilter extends Polymer.Element {
      static get is() { return 'glyconnect-filter'; }
      static get properties() {
        return {
          repos: {
            type: Array
          },
          selected: {
            type: String,
            value: 0
          },
          filterOutput: {
            type: Array,
            reflectToAttribute: true,
            notify: true
          },
          monosaccharides: {
            type: Array,
            value: ['Hex', 'HexNAc', 'dHex', 'NeuAc', 'NeuGc', 'Pen', 'S', 'P', 'Kdn', 'Kdo', 'HexA',  'Methyl', 'Acetyl', 'Other']
          },
          spareMonosac: {
            type: Array,
            value: ['S', 'P', 'Kdn', 'Kdo', 'HexA',  'Methyl', 'Acetyl', 'Other']
          },
          species: {
            type: Array,
          },
          fromUp: {
            type: Array,
            notify: true,
            reflectToAttribute: true
          },
          compositions: {
              type: String
          },
          compoCopied: {
              type: String
          },
          labels: {
              type: Object,
              value: {
                  'Hex': 'Hex',
                  'HexNAc': 'HexNAc',
                  'dHex': 'dHex',
                  'NeuAc': 'NeuAc',
                  'NeuGc': 'NeuGc',
                  'Pen': 'Pentose',
                  'S': 'Sulphate',
                  'P': 'Phosphate',
                  'Kdn': 'Kdn',
                  'Kdo': 'Kdo',
                  'HexA': 'HexA',
                  'Methyl' : 'Methyl',
                  'Acetyl' : 'Acetyl',
                  'Other': 'Other'
              }
          },
          protSpecies: {
              type: Object,
          },
          count: {
              type: Array,
          },
          textFromFileOx: {
              type: Array,
          },
        };
      }
      constructor() {
        super();
      }
      ready() {
       super.ready();
       Polymer.dom(this.root).querySelector('#selectedSpecies').hidden=true;
       Polymer.dom(this.root).querySelector('#protDropDown').addEventListener('change', e => {this.printSP(e)});
      }
      attached () {
          this.async(function(){this._setTogglesAndRSliders();},1);
      }
      openDialog() {
        this.$.dialog.open();
      }
      _searchProtein(){
        var myJson={};
        var protein = Polymer.dom(this.root).querySelector('#protDropDown').value;
        if (Polymer.dom(this.root).querySelector('#selectedSpecies').hidden==false){
          var allTaxo = Polymer.dom(this.$.selectedProtein).querySelectorAll("paper-button");
          for (var i = 0; i < allTaxo.length; i++) {
            var x = allTaxo[i].id;
            var y = x.replace('Prot-clone', '').replace('_', ' ');
            if (y === 'All'){continue;}
            if ('taxonomy' in myJson) {
              myJson['taxonomy'].push(y);
            } else {
              myJson['taxonomy']=[y];
            };
          };
        }
        myJson['protein']=protein;
        this.filterOutput = myJson;
      }
      uploadExperiment (event){
          event.preventDefault();
          var upload =  Polymer.dom(this.root).querySelector("#bUpload");
          var file = event.detail.file;
          var that = this;
          var glycosetta = Polymer.dom(this.root).querySelector("#oxfordFile");
          var reader = new FileReader();
          reader.onload = function(event) {
            upload.set(['files', upload.files.indexOf(file), 'status'], null);
              var extension = file.name.slice(-4);
              if(extension.toUpperCase() != ".TXT" ){
                  upload.set(['files', upload.files.indexOf(file), 'error'], 'Extension Error. File must be TXT (i.e. example.txt).');
                  return;
              }
              var text = event.target.result;
              text = text.replace(/\r?\n|\r/g, '').replace(/, /g, ',').trim();
              if(text.includes('Hex') === true){
                that.fromUp = that.parseCompo(text.split(","));
              }else{
                var fromSetta = glycosetta.translate(text.split(","));
                that.fromUp = fromSetta;
              }
            upload.set(['files', upload.files.indexOf(file), 'progress'], 100);
            upload.set(['files', upload.files.indexOf(file), 'complete'], true);
          };
          reader.readAsText(file);
      }
      sendData(){
        this.filterOutput = this.fromUp;
      }
      _getLabel (monosaccharide) {
          return this.labels[monosaccharide];
      }
      _getLabelSpecies(first){
        var second = first.replace(/ /g, "_");
        var third = second.replace(/\./g, "");
        return third
      }
      clearFilter(event) {
        var typeGlyco = event.target.getAttribute("typeLink");
        var vr = this.shadowRoot.querySelector("#selected"+typeGlyco);
        var toClear =  Polymer.dom(vr).querySelectorAll("paper-button");
        for (var i = 0; i < toClear.length; i++) {
          Polymer.dom(this.root).querySelector('paper-button[id='+toClear[i].id.replace("-clone",'')+']').hidden=false;
          toClear[i].remove();
        }
      }
      checkHowmany(event){
        if(this.species.length >1){
          this.createTag(event);
        };
      }
      createTag(event) {
       var typeTag = event.target.getAttribute("typeLink");
       var list = Polymer.dom(this.root).querySelector("#selected"+typeTag);
       var sourceEl = event.target;
       var cloneEl = sourceEl.cloneNode(true);
       event.target.hidden=true;
       cloneEl.id=cloneEl.id+"-clone";
       list.insertBefore(cloneEl, null);
       cloneEl.addEventListener('tap', e => {this.destroyTag(e)});
     }
     createSelector(event) {
       if(Polymer.dom(this.root).querySelector('#'+event.target.id+'toHide').hidden == true){
         Polymer.dom(this.root).querySelector('#'+event.target.id+'toHide').hidden=false;
       }else{
         Polymer.dom(this.root).querySelector('#'+event.target.id+'toHide').hidden=true;
       };
    }
     destroyTag(pr) {
       Polymer.dom(this.root).querySelector('paper-button[id='+pr.target.id.replace("-clone",'')+']').hidden=false;
      pr.target.remove();
     }
      _toggleGlycanFilter () {
          this._setTogglesAndRSliders();
          this.$.glycanFilterBox.toggle();
          if(this.$.foldIcon.hasAttribute('disabled')){
              this.$.expandIcon.setAttribute('disabled', 'true');
              this.$.foldIcon.removeAttribute('disabled');
          }else{
              this.$.foldIcon.setAttribute('disabled', 'true');
              this.$.expandIcon.removeAttribute('disabled');
          }
      }
      _setTogglesAndRSliders () {
          for (var idx in this.monosaccharides){
              var monosaccharide = this.monosaccharides[idx];
              Polymer.dom(this.root).querySelector("#"+monosaccharide+"RangeMin").value = 0;
          }
      }
      _getCompoList () {
        var compoRequest= {};
        var compolist = Polymer.dom(this.root).querySelector("#compoCommaList").value
        if(compolist != undefined){
            compolist = compolist.replace(/[.'\/#!$%\^\\\^&\*;:{}=\-_`~()]/g,"").split(",");
        }
        if(compolist[0].includes("Hex") === false){
         var parsedCompo= Polymer.dom(this.root).querySelector("#oxfordInput").translate(compolist);
         }else{
           var parsedCompo = this.parseCompo(compolist);
        };
       compoRequest['composition']=parsedCompo;
       this.filterOutput = compoRequest;
      }
      parseCompo(listOfCompo){
        var listOfFourteen = [];
        for(var c =0; c<listOfCompo.length; c ++){
          var mono = {'Hex': 0,'HexNAc': 0,'dHex': 0,'NeuAc': 0,'NeuGc': 0, 'Pen': 0, 'S': 0,'P': 0,'Kdn': 0,'Kdo': 0,'HexA': 0,'Met' : 0,'Ac' : 0,'Other':0};
          var extracted = listOfCompo[c].trim().split(' ');
          for(var b =0; b<extracted.length; b ++){
            var remaining = '';
            var quant = 0;
            var regex = /[2-9]/;
            var match = extracted[b].match(/\d+/g);
            if(match != null){
                var quantInd =  extracted[b].search(/\d/);
                quant += parseInt(extracted[b].substring(quantInd));
                remaining += extracted[b].substring(0, quantInd);
            }else{
              quant += 1;
              remaining += extracted[b];
            };
            if (remaining==='HexNAc') {
              mono['HexNAc'] += quant;
            } else if (remaining==='Hex') {
                  mono['Hex'] += quant; //Translating into integer and adding
            }else if (remaining==='dHex') {
                  mono['dHex'] += quant; //Translating into integer and adding
            }else if (remaining==='NeuAc') {
                  mono['NeuAc'] += quant; //Translating into integer and adding
            } else if (remaining==='NeuGc') {
                  mono['NeuGc'] += quant; //Translating into integer and adding
            }else if (remaining==='Pen') {
                  mono['Pen'] += quant; //Translating into integer and adding
            }else if (remaining==='S') {
                  mono['S'] += quant; //Translating into integer and adding
            }else if (remaining==='P') {
                  mono['P'] += quant; //Translating into integer and adding
            }else if (remaining==='Kdn') {
                  mono['Kdn'] += quant; //Translating into integer and adding
            }else if (remaining==='Kdo') {
                  mono['Kdo'] += quant; //Translating into integer and adding
            }else if (remaining==='HexA') {
                  mono['HexA'] += quant; //Translating into integer and adding
            }else if (remaining==='Met' || remaining==='Methyl') {
                  mono['Met'] += quant; //Translating into integer and adding
            }else if (remaining==='Ac' || remaining==='Acetyl') {
                  mono['Ac'] += quant; //Translating into integer and adding
            }else if (remaining==='Other') {
                  mono['Other'] += quant; //Translating into integer and adding
            };
          };
          var monoMerge = '';
          for(var key in mono){
            if (mono.hasOwnProperty(key)) {
                monoMerge += mono[key].toString();
            };
          };
          listOfFourteen.push(monoMerge);
        };
        return listOfFourteen;
      }
      getAllCompo (){
          var rangeBox = this.$.rangeBox;
          var paperInputs = Array.prototype.slice.call(rangeBox.getElementsByTagName('paper-slider'));
          var data = this;
          var compoString = '';
          var monosacDico = {};
          paperInputs.forEach(function (item) {
            // var edge = item.getAttribute('edge');
            var monosaccharideId = item.id.replace("RangeMin","");
            if (monosacDico.hasOwnProperty( monosaccharideId)){
              monosacDico[monosaccharideId] += data.shadowRoot.querySelector("#"+monosaccharideId+"RangeMin").value;
            }else{monosacDico[monosaccharideId]=''+data.shadowRoot.querySelector("#"+monosaccharideId+"RangeMin").value};
          });
          for (var key in monosacDico){
            if (monosacDico.hasOwnProperty(key)){
              compoString +=key+monosacDico[key]+' ';
            };
          };
          return compoString;
        }
      _getCompo () {
        if(Polymer.dom(this.root).querySelector("#compoFromSelectors").value==''){
          var compoToParse = this.getAllCompo();
          compoToParse = this.createStringCompo(compoToParse);
        }else{
          var compoToParse = Polymer.dom(this.root).querySelector("#compoFromSelectors").value;
        };
        var allCompo = compoToParse.split(', ');
        allCompo.splice(-1,1);
        var toVisualize = {};
        toVisualize['composition'] = this.parseCompo(allCompo);
        this.filterOutput = toVisualize;
        console.log(this.filterOutput)
      }
      _addCompo(){
        var compoToParse = this.getAllCompo();
        var parsed = this.createStringCompo(compoToParse);
        // var firstCompo=Polymer.dom(this.root).querySelector("#compoFromSelectors").value;
        Polymer.dom(this.root).querySelector("#compoFromSelectors").value +=parsed;
      }
      createStringCompo(compoFromSlider){
        var compoArray = compoFromSlider.split(' ')
        compoArray.splice(-1,1);
        var reWriteCompo = '';
        for (var ca=0; ca < compoArray.length; ca +=1){
            var itemMonosac = compoArray[ca];//+compoArray[ca+1];
            var firstDigit = itemMonosac.search(/\d/);
            var monos = itemMonosac.substring(0,firstDigit);
            var numberOf = itemMonosac.substring(firstDigit);
            if (numberOf === '0'){
              continue;
            }else if (numberOf === '1') {
              reWriteCompo += monos + ' '
            }else{reWriteCompo += monos+numberOf+ ' '}
        };
        return reWriteCompo.slice(0,-1)+', ';
      }
      resetSelector(){
        var rangeBox = this.$.rangeBox;
        var paperInputs = Array.prototype.slice.call(rangeBox.getElementsByTagName('paper-slider'));
        var filterObject = {};
        var data = this;
        paperInputs.forEach(function (item) {
            // var edge = item.getAttribute('edge');
            var rangeObject = {};
            var monosaccharideId = item.id.replace("RangeMin","");
            rangeObject["minRange"] = 0;
            rangeObject["presence"] = true;
            filterObject[monosaccharideId] = rangeObject;
            data.shadowRoot.querySelector("#"+monosaccharideId+"RangeMin").value = 0;
        });
        data.filter = filterObject;
        var spareMonosac = ['S', 'P', 'Kdn', 'Kdo', 'HexA',  'Methyl', 'Acetyl', 'Other'];
        for (var h = 0; h < spareMonosac.length; h++) {
          Polymer.dom(this.root).querySelector('#'+spareMonosac[h]+'toHide').hidden=true;
        };
      }
      _resetAll(){
        this.resetSelector();
        Polymer.dom(this.root).querySelector("#compoFromSelectors").value='';
      }
      selectedPropN (){
        var selN =  Polymer.dom(this.$.selectedN).querySelectorAll("paper-button");
        var jsonParam = this.param(selN);
        jsonParam.glycanType = 'n-linked';
        this.filterOutput = jsonParam;
      }
      selectedPropO(){
        var selO = Polymer.dom(this.$.selectedO).querySelectorAll("paper-button");
        var jsonParam = this.param(selO);
        jsonParam.glycanType = 'o-linked';
        this.filterOutput = jsonParam;
      }
      selectedPropNP(){
        var selNP = Polymer.dom(this.$.selectedNP).querySelectorAll("paper-button");
        var jsonParam = this.param(selNP);
        jsonParam.glycanType = 'free';
        this.filterOutput = jsonParam;
      }
      param(propArray){
        var myJson = {};
        for (var i = 0; i < propArray.length; i++) {
          var x = propArray[i].getAttribute("data-id");
          var s = x.split("=");
          if (s[0] in myJson) {
            myJson[s[0]].push(s[1])
          } else {
            myJson[s[0]]=[s[1]];
          }
        }
        return myJson;
      }
      connectedCallback (){
        super.connectedCallback();
        this.$.ajaxDictionary.url = this.resolveUrl('dictionary/jsonGlobalProperties.json');
        this.$.ajaxDictionary.generateRequest();
        this.$.proteinDictionary.url = this.resolveUrl('http://mendel.isb-sib.ch:8083/api/proteins');
        this.$.proteinDictionary.generateRequest();
        // this.$.compoDictionary.url = this.resolveUrl('http://mendel.isb-sib.ch:8083/api/glycosylations?composition?');
        // this.$.compoDictionary.generateRequest();
      }
      handleResponse(data){
        var jsonGlobalProperties = data.detail.response;
        this.coreTypeO = jsonGlobalProperties['O-linked']['core'];
        this.coreTypeN = jsonGlobalProperties['N-linked']['core'];
        this.propO = jsonGlobalProperties['O-linked']['prop'];
        this.propN = jsonGlobalProperties['N-linked']['prop'];
        this.detO = jsonGlobalProperties['O-linked']['det'];
        this.detN = jsonGlobalProperties['N-linked']['det'];
        this.propNP = jsonGlobalProperties['Non attached to proteins']['prop'];
        this.detNP = jsonGlobalProperties['Non attached to proteins']['det'];
        this.coreTypeNP = jsonGlobalProperties['Non attached to proteins']['core'];
      }
      handleProtein(data){
        var jsonProtein = data.detail.response;
        var proteinList = [];
        var proteinIds = [];
        var nameSpecies = {};
        var allSp = [];
        for (var f =0; f < jsonProtein.length; f ++){
          var protFeatures = jsonProtein[f];
          var tax = protFeatures['taxonomy'];
          allSp.push(tax);
          name = protFeatures['name'].toLowerCase().replace(" ","");
          if (nameSpecies.hasOwnProperty(name)){
            nameSpecies[name].push(tax);
          }else{
            nameSpecies[name] = [tax];
            proteinList.push(protFeatures['name']);
          };
          if (protFeatures['uniprots'] != undefined){
            var accs = protFeatures['uniprots'];
            var uniAcc;
            for ( uniAcc in accs){
              nameSpecies[accs[uniAcc]['uniprot_acc'].toLowerCase()]=[tax];
              proteinIds.push(accs[uniAcc]['uniprot_acc']);
            };
          };
        };
        var result = { };
        for(var i = 0; i < allSp.length; ++i) {
            if(!result[allSp[i]])
                result[allSp[i]] = 0;
            ++result[allSp[i]];
        };
        this.count = result;
        Array.prototype.push.apply(proteinList, proteinIds);
        var combobox = Polymer.dom(this.root).querySelector('#protDropDown');
        var elements = proteinList;//["Hydrogen", "Helium", "Silicon"];
        combobox.items = elements;
        this.protSpecies = nameSpecies;
      }
      printSP (e){
        this.clearFilter(e);
        var val = Polymer.dom(this.root).querySelector('#protDropDown').value;
        if(val != ''){
          var speciesForChoice = this.protSpecies[val.toLowerCase().replace(" ","")];
          var newSpecies = speciesForChoice.slice(0);
        }else{
          var newSpecies = [];
        };
        newSpecies.sort();
        var newArray = [];
        for (var s=0; s<newSpecies.length; s ++){
          if (newArray.length == 0){
            newArray.push(newSpecies[s])
          }else{
            if(newArray.includes(newSpecies[s])){
              continue;
            }else{
              newArray.push(newSpecies[s]);
            };
          };
        }
        if(newArray.length >1){
          newSpecies = this.orderSpecies(newSpecies);
          Polymer.dom(this.root).querySelector('#selectedSpecies').hidden=false;
          newArray.push('All');
        }else{
          Polymer.dom(this.root).querySelector('#selectedSpecies').hidden=true;
        };
        this.species = newArray;
      }
      orderSpecies(listOfSpecies){
        var countSpecies = this.count;
        var toOrder = {};
        var sortable = [];
        for(var w =0; w < listOfSpecies.length; w++){
          toOrder[listOfSpecies[w]]=countSpecies[listOfSpecies[w]];
        };
        for (var speci in toOrder) {
            sortable.push([speci, toOrder[speci]]);
        };
        sortable.sort(function(a, b) {
            return b[1] -a[1];
        });
        var sorted = [];
        for(var t =0; t < sortable.length; t++){
          sorted.push(sortable[t][0]);
        };
        return sorted
      }
      _toggleProtein () {
        this.$.glycanFilterProt.toggle();
        this.expandFold()
      }
      _toggleNGlycan () {
        this.$.glycanFilterN.toggle();
        this.expandFold()
      }
      _toggleOGlycan () {
        this.$.glycanFilterO.toggle();
        this.expandFold()
      }
      _toggleNOGlycan () {
        this.$.glycanFilterNO.toggle();
        this.expandFold()
      }
      expandFold (){
        if(this.$.foldIcon.hasAttribute('disabled')){
          this.$.expandIcon.setAttribute('disabled', 'true');
          this.$.foldIcon.removeAttribute('disabled');
        }else{
          this.$.foldIcon.setAttribute('disabled', 'true');
          this.$.expandIcon.removeAttribute('disabled');
        }
      }
     idCreator(id) {
       return "d_"+id.replace(/ /g,'').replace(/\(/g, '').replace(/\)/g, '').replace(/\,/g, "").replace("/","").replace(/\'/g,"");
     }
    }
    window.customElements.define(GlyconnectFilter.is, GlyconnectFilter);
    </script>
</dom-module>
